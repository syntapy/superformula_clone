name: cypress

permissions: read-all
on: [push]

env:
  NODE_VERSION: 22
  DISPLAY: ""
  CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
  CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: checkout ${{ env.GITHUB_REF }}
        uses: actions/checkout@v3
      - run: env
      - name: pull images
        run: docker compose pull
        #- name: tmate session
        #uses: mxschmitt/action-tmate@v3
      - name: gatsby - npm install
        run: docker compose run --rm -u root gatsby ci
        #- name: cypress - npm install
        #run: docker compose run --rm -u root e2e_client ci
      - name: gatsby develop
        run: docker compose -f docker-compose.yml -f docker-compose.actions.yml up --wait gatsby
      - name: run e2e tests
        run: docker compose -f docker-compose.yml -f docker-compose.actions.yml run --rm e2e_client run e2e
      - name: Upload image diff outputs
        uses: actions/upload-artifact@v3
        with:
          name: e2e image output directory
          path: gatsby/cypress/snapshots/
        if: failure()
  lighthouse_audit:
    runs-on: ubuntu-latest
    steps:
      - name: checkout ${{ env.GITHUB_REF }}
        uses: actions/checkout@v3
      - run: env
      - name: pull images
        run: docker compose pull
        #- name: tmate session
        #uses: mxschmitt/action-tmate@v3
      - name: gatsby - npm install
        run: docker compose run --rm -u root gatsby ci
        #- name: cypress - npm install
        #run: docker compose run --rm -u root e2e_client ci
      - name: gatsby develop
        run: docker compose -f docker-compose.yml -f docker-compose.actions.yml up --wait gatsby
      - name: run e2e tests
        run: docker compose -f docker-compose.yml -f docker-compose.actions.yml run --rm e2e_client run audit
      - name: Upload image diff outputs
        uses: actions/upload-artifact@v3
        with:
          name: e2e image output directory
          path: gatsby/cypress/snapshots/
        if: failure()
